<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no,minimal-ui">
    <meta name="format-detection" content="telephone=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.bootcss.com/minireset.css/0.0.2/minireset.css">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div id="root" class="container">
        <div class="m-artical-action">
            <div class="artical-action-mid" id="action_mid">

            </div>
        </div>
        <div id="top-nav" class="top-nav" style="display:none">
            <div class="icon-back"></div>
            <div class="nav-title">返回书架</div>
        </div>
        <div id="fition_chapter_title">
        </div>
        <div id="fition_container" class="m-read-content">

        </div>
        <div class="u-btn">
            <ul class="u-tab">
                <li id="prev">上一章</li>
                <li id="next">下一章</li>
            </ul>
        </div>
        <div id="nav-bottom" class="nav-bottom" style="display:none">
            <ul>
                <li>
                    <div class="icon-mulu"></div>
                    <div class="nav-bottom-title">目录</div>
                </li>
                <li id="font-btn">
                    <div class="icon-ziti"></div>
                    <div class="nav-bottom-title">字体</div>
                </li>
                <li id="night_day">
                    <div class="icon-yejian"></div>
                    <div class="nav-bottom-title">夜间</div>
                </li>
            </ul>
        </div>
        <div class="nav-pannel" id="font-content" style="display:none">
            <div class="child-mod font-size">
                <span>字号</span>
                <button id="large-font" class="font-size-btn">大</button>
                <button id="small-font" class="font-size-btn">小</button>
            </div>
            <div class="child-mod font-color">
                <span>背景</span>
                <div class="bk-container">
                    <div class="bk-container-current">
                    </div>
                </div>
                <div class="bk-container">
                    <div class="bk-container-current">
                    </div>
                </div>
                <div class="bk-container">
                    <div class="bk-container-current">
                    </div>
                </div>
            </div>

        </div>
    </div>
    <script src="https://cdn.bootcss.com/zepto/1.2.0/zepto.min.js"></script>

    <script>
        //指定 jQuery 为zepto的$
        window.jQuery = $;
    </script>
    <script src="https://cdn.bootcss.com/jQuery-JSONP/2.4.0/jquery.jsonp.min.js"></script>
    <script src="https://cdn.bootcss.com/Base64/1.0.1/base64.min.js"></script>
    <script>
        (function () {
            //定义键名加上prefix的localStorage的存取
            var Util = (function () {
                var prefix = 'html5_reader'
                var StorageGetter = function (key) {
                    return localStorage.getItem(prefix + key);
                }
                var StorageSetter = function (key, val) {
                    return localStorage.setItem(prefix + key, val);
                }
                var getBSONP = function (url, callback) {
                    return $.jsonp({
                        url: url,
                        cache: true,
                        callback: 'duokan_fiction_chapter',
                        success: function (result) {
                            var data = atob(result);
                            var json = decodeURIComponent(escape(data))
                            callback(json);
                        }
                    })
                }
                return {
                    getBSONP: getBSONP,
                    StorageGetter: StorageGetter,
                    StorageSetter: StorageSetter,
                }
            })()

            var Dom = {
                top_nav: $('#top-nav'),
                bottom_nav: $('#nav-bottom'),
                font_content: $('#font-content'),
                font_btn: $('#font-btn')
            }
            var Win = $(window);
            var Doc = $(document);
            var RootContainer = $('#fition_container');
            var initFontSize = parseInt(Util.StorageGetter('font_size')) || 14;
            var readerUI;
            var readerModel;

            function main() {
                //入口函数
                RootContainer.css('font-size', initFontSize);
                EventHadnlder();
                readerUI = readerBaseFrame(RootContainer);
                readerModel = new ReaderModel();
                readerModel.init(function (data) {
                    readerUI(data)
                })

            }

            function ReaderModel() {
                //todo 实现和阅读器相关的数据交互方法
                var ID;
                var init = function (callback) {
                    getFicitonInfo(function () {
                        getChapterContent(ID, function (data) {
                            callback(data)
                        })
                    })
                }
                var getFicitonInfo = function (callback) {
                    $.get('data/chapter.json', function (data) {
                        ID = data.chapters[1].chapter_id;
                        callback && callback()
                    }, 'json')
                }
                var getChapterContent = function (id, callback) {
                    $.get('data/data' + id + '.json', function (data) {
                        if (data.result == 0) {
                            var url = data.jsonp;
                            Util.getBSONP(url, function (data) {
                                callback && callback(data)
                            });
                        }
                    }, 'json')
                }
                return {
                    init: init
                }
            }

            function readerBaseFrame(container) {
                //渲染基本的UI结构
                //解析章节数据
                function parseChapterData(jsonData) {
                    var jsonObj = JSON.parse(jsonData);
                    var html = "<h4>" + jsonObj.t + "</h4>";
                    for (var i = 0; i < jsonObj.p.length; i++) {
                        html += "<p>" + jsonObj.p[i] + "</p>";
                    }
                    return html;
                }
                return function (data) {
                    container.html(parseChapterData(data));
                }
            }


            function EventHadnlder() {
                //todo
                $('#action_mid').click(function () {
                    if (Dom.top_nav.css('display') == 'none') {
                        Dom.bottom_nav.show();
                        Dom.top_nav.show();
                    } else {
                        Dom.bottom_nav.hide();
                        Dom.top_nav.hide();
                    }
                })
                $('#font-btn').click(function () {
                    if (Dom.font_content.css('display') == 'none') {
                        Dom.font_content.show();
                        Dom.font_btn.addClass('current')
                    } else {
                        Dom.font_content.hide();
                        Dom.font_btn.removeClass('current')
                    }
                })
                $('#night_day').click(function () {
                    //TODOc触发背景切换事件
                })
                $('#large-font').click(function () {
                    if (initFontSize >= 20) {
                        return;
                    }
                    initFontSize += 1;
                    RootContainer.css('font-size', initFontSize);
                    Util.StorageSetter('font_size', initFontSize);
                })
                $('#small-font').click(function () {
                    if (initFontSize <= 10) {
                        return;
                    }
                    initFontSize -= 1;
                    RootContainer.css('font-size', initFontSize);
                    Util.StorageSetter('font_size', initFontSize);
                })
                Win.scroll(function () {
                    Dom.bottom_nav.hide();
                    Dom.top_nav.hide();
                    Dom.font_content.hide();
                    Dom.font_btn.removeClass('current')
                })

            }

            main();
        })()
    </script>

</body>

</html>